<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>Bluenet: Installation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">0.0.2</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Installation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Manual</h2>
<p>Rather than going through this page, it is also possible to go through the SDK, which has a nice installation manual. It has been test driven by around 50 students, so it pretty thorougly captures most of the edge cases:</p>
<ul>
<li><a href="https://docs.google.com/document/d/1W-UfzLD4jOh_F5iSbDKcMxwTOVEVfT2QVTTjQlZCXrc/edit">Crownstone SDK manual</a></li>
</ul>
<h2>Prerequisites</h2>
<p>The installation should not be hard when you have the Nordic SDK. Get this from their website after buying a development kit. You also need a cross-compiler for ARM. You need the JLink utilities from Segger. And you need cmake for the build process.</p>
<ul>
<li><a href="https://developer.nordicsemi.com/nRF5_SDK/nRF51_SDK_v8.x.x/">Nordic nRF51822 SDK 8.1</a></li>
<li><a href="http://www.nordicsemi.com/eng/Products/S110-SoftDevice-v8.0">Nordic S110 Softdevice 8.0</a> or <a href="https://www.nordicsemi.com/eng/Products/S130-SoftDevice">Nordic S1130 Softdevice 1.0</a></li>
<li><a href="http://www.segger.com/jlink-software.html">JLink Software</a>, there is a <a href="https://www.segger.com/jlink-software.html?step=1&amp;file=JLinkLinuxDEB64_4.96.4">.deb file</a></li>
<li>sudo aptitude install cmake</li>
</ul>
<p>A cross-compiler for ARM is the <code>GCC</code> cross-compiler which is maintained by the ARM folks on <a href="https://launchpad.net/gcc-arm-embedded">Launchpad</a>. </p><pre class="fragment">curl -v -O https://launchpad.net/gcc-arm-embedded/4.8/4.8-2014-q3-update/+download/gcc-arm-none-eabi-4_8-2014q3-20140805-linux.tar.bz2
tar -xvf gcc-arm-none-eabi-4_8-2014q3-20140805-linux.tar.bz2 -C /opt
</pre><p>This is a 32-bit application, so you will need some dependencies: </p><pre class="fragment">sudo apt-get install libstdc++6:i386 libncurses5:i386
</pre><p>If the cross-compiler does not work, make sure you check if all its dependencies are met: </p><pre class="fragment">ldd /opt/gcc-arm-none-eabi-4_8-2014q3/bin/arm-none-eabi-gcc
</pre><p>Unpack the Nordic files to for example the <code>/opt/softdevices</code> and <code>/opt/nrf51_sdk</code> directories.</p>
<p>It is a <code>cmake</code> build system, so you will need it: </p><pre class="fragment">sudo apt-get install cmake
</pre><p>You can now just type <code>make</code> in the main directory. Or you can build using the scripts (see below). Before that you'll have to adjust the default configuration settings (see below as well).</p>
<h3>Bugs</h3>
<p>There is a bug in the following softdevice files, namely <code>nrf_svc.h</code>: </p><pre class="fragment">/opt/softdevices/s110_nrf51_8.0.0_API/include
/opt/softdevices/s130_nrf51_1.0.0_API/include
</pre><p>Change the assembly line: </p><pre class="fragment">    "bx r14" : : "I" (number) : "r0" \
</pre><p>Into: </p><pre class="fragment">    "bx r14" : : "I" ((uint16_t)number) : "r0" \
</pre><h2>Usage</h2>
<p>You will have to attach a programmer/debugger somehow. Towards that you only need four pins. On the RFduino this is <code>GND</code>, <code>3V</code>, <code>RESET</code>, and <code>FACTORY</code> and they are subsequent pins on that side of the RFduino where there are most pins (the other side has the antenna stealing a bit of space for eventual pins). The pin layout of the JLink connector is written out on the <a href="http://dobots.nl/2014/03/05/rfduino-without-rfduino-code/">DoBots blog</a>.</p>
<h3>Configuration</h3>
<p>Fork the code by clicking on:</p>
<ul>
<li>Fork <a href="https://github.com/dobots/bluenet/fork">https://github.com/dobots/bluenet/fork</a>.</li>
<li><code>git clone <a href="https://github.com/${YOUR_GITHUB_USERNAME}/bluenet">https://github.com/${YOUR_GITHUB_USERNAME}/bluenet</a></code></li>
<li>let us call this directory $BLUENET_DIR</li>
</ul>
<p>Now you will have to set all fields in the configuration file:</p>
<ul>
<li>cp CMakeBuild.config.default CMakeBuild.config</li>
<li>adjust the <code>NRF51822_DIR</code> to wherever you installed the Nordic SDK (it should have <code>/Include</code> and <code>/Source</code> subdirectories</li>
<li>adjust the <code>SOFTDEVICE_DIR</code> to wherever you unzipped the SoftDevice from Nordic</li>
<li>adjust the <code>SOFTDEVICE_SERIES</code> to for example <code>110</code> or <code>130</code> (SoftDevice name starts with it, without the <code>s</code>)</li>
<li>adjust major accordingly <code>SOFTDEVICE_MAJOR=8</code></li>
<li>adjust minor accordingly <code>SOFTDEVICE_MINOR=0</code></li>
<li>adjust the <code>SOFTDEVICE_DIR_API</code> to the directory with the SoftDevice include files</li>
<li>set <code>SOFTDEVICE_NO_SEPARATE_UICR_SECTION=1</code> if you use one of the earlier s110 softdevices with a separate UICR section</li>
<li>adjust the type <code>SOFTDEVICE</code> accordingly (basename of file without <code>_softdevice.hex</code>)</li>
<li>set the <code>APPLICATION_START_ADDRESS</code> to start of application in FLASH (called <code>CODE_R1_BASE</code> in Nordic documentation)</li>
<li>set the <code>APPLICATION_LENGTH</code> to what remains of FLASH</li>
<li>set <code>RAM_R1_BASE</code> to the start of RAM that is available (SoftDevice S130 v0.5 uses a staggering 10kB from the 16kB!)</li>
<li>set <code>RAM_APPLICATION_AMOUNT</code> to what remains for the application in RAM</li>
<li>adjust the <code>COMPILER_PATH</code> and <code>COMPILER_TYPE</code> to your compiler (it will be used as <code>$COMPILER_PATH\bin\$COMPILER_TYPE-gcc</code>)</li>
<li>adjust <code>JLINK</code> to the full name of the JLink utility (JLinkExe on Linux)</li>
<li>adjust <code>JLINK_GDB_SERVER</code> to the full name of the JLink utility that supports gdb (JLinkGDBServer on Linux)</li>
<li>set <code>BLUETOOTH_NAME</code> to something you like, but make sure it's short.</li>
<li>adjust <code>INDOOR_SERVICE</code> to <code>1</code> if you want to enable it, the same is true for the other services</li>
<li>adjust <code>CHAR_MESHING</code> to <code>1</code> if you want to enable meshing functionality, the same is true for other characteristics</li>
<li>adjust <code>HARDWARE_BOARD</code> to the correct number for your board. This determines the pin layout.</li>
<li>adjust <code>HARDWARE_VERSION</code> to the correct version of the NRF51 chip you have. Use script/hardware_version.sh to check your version.</li>
<li>adjust <code>SERIAL_VERBOSITY</code> to the value you prefer. Set it to None to disable all logging over serial. The default is 1 (info).</li>
<li>adjust <code>MASTER_BUFFER_SIZE</code> if you want to have a larger buffer (this buffer is reused by all characteristics that use more than a single byte or string)</li>
</ul>
<p>Let us now install the SoftDevice on the nRF51822: </p><pre class="fragment">cd $BLUENET_DIR/scripts
./softdevice.sh build
./softdevice.sh upload
</pre><p>Now we can build our own software: </p><pre class="fragment">cd $BLUENET_DIR
make
</pre><p>Alternatively, you can build it using our script: </p><pre class="fragment">cd $BLUENET_DIR/scripts
./firmware.sh build crownstone
</pre><p>There is also an upload and debug script. The first uses <code>JLink</code> to upload, the second uses <code>gdb</code> to attach itself to the running process: </p><pre class="fragment">./firmware.sh upload crownstone
./firmware.sh debug crownstone
</pre><p>You can also run everything in sequence: </p><pre class="fragment">./firmware.sh all crownstone
</pre><p>And there you go. There are some more utility scripts, such as <code>reboot.sh</code>. Use as you wish.</p>
<h2>Flashing with the ST-Link</h2>
<p>The above assumes you have the J-Link programmer from Nordic. If you do not have that device, you can still program something like the RFduino or the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>, by using an ST-Link. A full explanation can be found on <a href="https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link/">https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link/</a>.</p>
<h3>Combine softdevice and firmware</h3>
<p>First of all you should combine all the required binaries into one big binary. This is done by the script combine.sh. Before you use it, you will need to install srec_cat on your system. </p><pre class="fragment">sudo apt-get install srecord
</pre><p>If you call the script it basically just runs srec_cat: </p><pre class="fragment">./combine.sh
</pre><p>And you will see that it runs something like this: </p><pre class="fragment">srec_cat /opt/softdevices/s110_nrf51822_7.0.0_softdevice.hex -intel crownstone.bin -binary -offset 0x00016000 -o combined.hex -intel
</pre><p>You have to adjust that file on the moment manually to switch between softdevices or to add/remove the bootloader, sorry! Note that the result is a <code>.hex</code> file. Such a file does haveinformation across multiple memory sections. If you upload a <code>.bin</code> file often configuration bits/bytes will not be set!</p>
<h3>Upload with OpenOCD</h3>
<p>Rather than downloading <code>openocd</code> from the Ubuntu repositories, it is recommended to get the newest software from the source: </p><pre class="fragment">cd /opt
git clone https://github.com/ntfreak/openocd
sudo aptitude install libtool automake libusb-1.0-0-dev expect
cd openocd
./bootstrap
./configure --enable-stlink
make
sudo make install
</pre><p>Also, make sure you can use the USB ST-Link device without sudo rights: </p><pre class="fragment">sudo cp scripts/openocd/49-stlinkv2.rules /etc/udev/rules.d
sudo restart udev
</pre><p>You can now use the <code>flash_openocd.sh</code> script in the <code>scripts</code> directory: </p><pre class="fragment">./flash_openocd.sh init
</pre><p>And in another console: </p><pre class="fragment">./flash_openocd.sh upload combined.bin
</pre><p>Here the binary <code>combined.bin</code> is the softdevice and application combined.</p>
<h2>Meshing</h2>
<p>The meshion functionality is the one we are currently integrating on the moment. So, this is a moving target. In addition, the mesh code is relatively memory intensive, so you will need a 32kB version to run it. Set <code>CHAR_MESHING</code> to <code>1</code> if you want to use it.</p>
<p>For the meshing functionality we use <a href="https://github.com/NordicSemiconductor/nRF51-ble-bcast-mesh">https://github.com/NordicSemiconductor/nRF51-ble-bcast-mesh</a> written by a Trond Einar Snekvik, department of Engineering Cybernetics at Norwegian University of Science and Technology (and Nordic Semiconductors).</p>
<h2>UART</h2>
<p>Currently UART for debugging. In case you happen to have the nRFgo Motherboard (nRF6310, strongly recommended) you can easily connect the pints at P2.0 and P2.1 to respectively the pins RXD and TXD on P15 on the board. Do not forget to switch on the RS232 switch. Subsequently you will need some RS232 to USB cable if you haven't an extremely old laptop. The current set baudrate you can find in <code>src/serial.cpp</code> and is <code>38400</code> baud. To read from serial, my personal favorite application is <code>minicom</code>, but feel free to use any other program. </p><pre class="fragment">(sudo) minicom -c on -s -D /dev/ttyUSB0
</pre><p>The sudo rights are only necessary if your <code>udev</code> rights are not properly set. The above flags just set colors to <code>on</code> and define the right usb port to use (if you've multiple).</p>
<h2>Bootloader</h2>
<p>To upload a new program when the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> is embedded in a wall socket is cumbersome. For that reason for deployment we recommend to add a bootloader. We adjusted the Nordic bootloader so that it works with the bluenet code: </p><pre class="fragment">git clone https://github.com/dobots/nrf51-dfu-bootloader-for-gcc-compiler
cd scripts
./all.sh
</pre><p>Make sure to choose the correct branch.</p>
<p>You will have to set some fields such that the bootloader is loaded rather than the application directly. If you use the <code>J-Link</code> this script will install bootloader, softdevice, and application: </p><pre class="fragment">./all.sh
</pre><p>And you should be good to upload binaries, for example with the following python script: </p><pre class="fragment">git clone https://github.com/dobots/nrf51_dfu_linux
python dfu.py -f crownstone.hex -a CD:E3:4A:47:1C:E4
</pre><h3>Debugging bootloader</h3>
<p>Make sure the bootloader is actually loaded and the proper address for the application is set. If you use the <code>J-Link</code> you can use <code>./general_command.sh</code> to read individual memory locations: </p><pre class="fragment">mem 0x10001014 4
</pre><p>This should be equal to <code>BOOTLOADER_REGION_START</code> if you use the bootloader. If it is <code>0xFFFF</code> the application will be loaded from the application start address.</p>
<p>If the bootloader does not find a valid app, there might indeed not be an app available, o its configuration field that tells it that the app is correct isn't set properly: </p><pre class="fragment">mem 3FC00 10
</pre><p>This should return <code>0000 0001 0000 0000 0000 00FE 0000 0000</code>. If it isn't set correctly, make sure you have uploaded the <code>bootloader.hex</code> file (and not only the <code>bootloader.bin</code> file).</p>
<h2>iBeacon</h2>
<p>There is iBeacon functionality, if you want to try that out. For that you will need to set a define in the main file. </p><pre class="fragment">#define IBEACON
</pre><p>This is not the normal operation mode of the Crownstones, and it is not guaranteed to stay. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
